<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - Proyecto ML</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cuenta.css') }}">
</head>
<body>
    <div class="cuenta-wrapper">
        <!-- Menu Lateral -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="profile-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h2>{{ usuario.nombre }} {{ usuario.apellido }}</h2>
                <p class="profile-email">{{ usuario.correo }}</p>
            </div>

            <nav class="sidebar-nav">
                <a href="{{ url_for('cuenta', seccion='datos-personales') }}"
                   class="nav-item {% if seccion_activa == 'datos-personales' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Datos Personales</span>
                </a>

                <a href="{{ url_for('cuenta', seccion='resultados') }}"
                   class="nav-item {% if seccion_activa == 'resultados' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    <span>Resultados</span>
                </a>

                <a href="{{ url_for('cuenta', seccion='seguridad') }}"
                   class="nav-item {% if seccion_activa == 'seguridad' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>Seguridad</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="{{ url_for('index') }}" class="btn-secondary-sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    </svg>
                    Inicio
                </a>
                <a href="{{ url_for('logout') }}" class="btn-danger-sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Salir
                </a>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <main class="main-content">
            <!-- Alertas -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="alerts-container">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">
                                {{ message }}
                                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Seccion: Datos Personales -->
            {% if seccion_activa == 'datos-personales' %}
            <div class="section-container">
                <div class="section-header">
                    <h1>Datos Personales</h1>
                    <p>Administra tu informacion personal</p>
                </div>

                <form id="perfilForm" action="{{ url_for('actualizar_cuenta') }}" method="POST" class="profile-form">
                    <div class="form-section">
                        <h3>Informacion Basica</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="nombre">Nombre *</label>
                                <input type="text" id="nombre" name="nombre" value="{{ usuario.nombre }}" required disabled>
                            </div>

                            <div class="form-group">
                                <label for="apellido">Apellido *</label>
                                <input type="text" id="apellido" name="apellido" value="{{ usuario.apellido }}" required disabled>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="edad">Edad *</label>
                                <input type="number" id="edad" name="edad" value="{{ usuario.edad }}" min="1" max="120" required disabled>
                            </div>

                            <div class="form-group">
                                <label for="genero">Genero *</label>
                                <select id="genero" name="genero" required disabled>
                                    <option value="M" {% if usuario.genero == 'M' %}selected{% endif %}>Masculino</option>
                                    <option value="F" {% if usuario.genero == 'F' %}selected{% endif %}>Femenino</option>
                                    <option value="O" {% if usuario.genero == 'O' %}selected{% endif %}>Otro</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="correo">Correo Electronico *</label>
                            <input type="email" id="correo" name="correo" value="{{ usuario.correo }}" required disabled>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Informacion Adicional</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha_nacimiento">Fecha de Nacimiento</label>
                                <input type="date" id="fecha_nacimiento" name="fecha_nacimiento"
                                       value="{{ usuario.fecha_nacimiento if usuario.fecha_nacimiento else '' }}" disabled>
                            </div>

                            <div class="form-group">
                                <label for="grado_escolaridad">Grado de Escolaridad</label>
                                <select id="grado_escolaridad" name="grado_escolaridad" disabled>
                                    <option value="">Seleccionar...</option>
                                    <option value="Primaria" {% if usuario.grado_escolaridad == 'Primaria' %}selected{% endif %}>Primaria</option>
                                    <option value="Secundaria" {% if usuario.grado_escolaridad == 'Secundaria' %}selected{% endif %}>Secundaria</option>
                                    <option value="Preparatoria" {% if usuario.grado_escolaridad == 'Preparatoria' %}selected{% endif %}>Preparatoria</option>
                                    <option value="Universidad" {% if usuario.grado_escolaridad == 'Universidad' %}selected{% endif %}>Universidad</option>
                                    <option value="Posgrado" {% if usuario.grado_escolaridad == 'Posgrado' %}selected{% endif %}>Posgrado</option>
                                    <option value="Doctorado" {% if usuario.grado_escolaridad == 'Doctorado' %}selected{% endif %}>Doctorado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="btnEditar" class="btn-primary" onclick="habilitarEdicion()">Editar</button>
                        <button type="submit" id="btnGuardar" class="btn-success" style="display: none;">Guardar Cambios</button>
                        <button type="button" id="btnCancelar" class="btn-secondary" style="display: none;" onclick="cancelarEdicion()">Cancelar</button>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Seccion: Resultados -->
            {% if seccion_activa == 'resultados' %}
            <div class="section-container">
                <div class="section-header">
                    <h1>Historial de Resultados</h1>
                    <p>Revisa tu progreso y evaluaciones anteriores</p>
                </div>

                {% if estadisticas and estadisticas.total_evaluaciones > 0 %}
                <!-- Estadisticas Generales -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <h3>{{ estadisticas.total_evaluaciones }}</h3>
                            <p>Evaluaciones Totales</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📈</div>
                        <div class="stat-content">
                            <h3>{{ "%.2f"|format(estadisticas.promedio_puntaje) }}</h3>
                            <p>Promedio General</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⬆️</div>
                        <div class="stat-content">
                            <h3>{{ "%.2f"|format(estadisticas.puntaje_maximo) }}</h3>
                            <p>Puntaje Maximo</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⬇️</div>
                        <div class="stat-content">
                            <h3>{{ "%.2f"|format(estadisticas.puntaje_minimo) }}</h3>
                            <p>Puntaje Minimo</p>
                        </div>
                    </div>
                </div>

                <!-- Resumen Semanal -->
                {% if resultados_semana %}
                <div class="results-section">
                    <h2>Ultimos 7 dias ({{ resultados_semana|length }} evaluaciones)</h2>
                    <div class="results-list">
                        {% for resultado in resultados_semana %}
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-level result-level-{{ resultado.nivel_prediccion|lower|replace(' ', '-') }}">
                                    {{ resultado.nivel_prediccion }}
                                </div>
                                <div class="result-date">
                                    {{ resultado.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}
                                </div>
                            </div>
                            <div class="result-body">
                                <div class="result-score">
                                    <span class="score-label">Puntaje:</span>
                                    <span class="score-value">{{ "%.2f"|format(resultado.puntaje_prediccion) }}</span>
                                </div>
                                <div class="result-recommendations">
                                    <h4>Recomendaciones:</h4>
                                    <ul>
                                        {% for rec in resultado.recomendaciones[:3] %}
                                        <li>{{ rec }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    <p>No hay evaluaciones en los ultimos 7 dias</p>
                </div>
                {% endif %}

                <!-- Historial Completo (ultimos 5) -->
                {% if resultados %}
                <div class="results-section">
                    <h2>Ultimas Evaluaciones</h2>
                    <div class="results-timeline">
                        {% for resultado in resultados %}
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <div class="result-level result-level-{{ resultado.nivel_prediccion|lower|replace(' ', '-') }}">
                                        {{ resultado.nivel_prediccion }}
                                    </div>
                                    <span class="timeline-date">{{ resultado.fecha_creacion.strftime('%d/%m/%Y') }}</span>
                                </div>
                                <div class="timeline-body">
                                    <p><strong>Puntaje:</strong> {{ "%.2f"|format(resultado.puntaje_prediccion) }}</p>
                                    <details>
                                        <summary>Ver detalles</summary>
                                        <div class="details-content">
                                            <h5>Factores de Riesgo:</h5>
                                            <ul>
                                                {% for factor in resultado.factores_riesgo %}
                                                <li>{{ factor }}</li>
                                                {% endfor %}
                                            </ul>
                                            <h5>Recomendaciones:</h5>
                                            <ul>
                                                {% for rec in resultado.recomendaciones %}
                                                <li>{{ rec }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% else %}
                <!-- Estado vacio -->
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <h3>No hay resultados disponibles</h3>
                    <p>Completa el formulario de evaluacion para ver tus resultados aqui</p>
                    <a href="{{ url_for('formulario') }}" class="btn-primary">Ir al Formulario</a>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Seccion: Seguridad -->
            {% if seccion_activa == 'seguridad' %}
            <div class="section-container">
                <div class="section-header">
                    <h1>Seguridad</h1>
                    <p>Administra la seguridad de tu cuenta</p>
                </div>

                <form action="{{ url_for('cambiar_contrasena') }}" method="POST" class="security-form">
                    <div class="form-section">
                        <h3>Cambiar Contrasena</h3>
                        <p class="form-description">Para cambiar tu contrasena, ingresa tu contrasena actual y la nueva contrasena.</p>

                        <div class="form-group">
                            <label for="clave_actual">Contrasena Actual *</label>
                            <input type="password" id="clave_actual" name="clave_actual" required>
                        </div>

                        <div class="form-group">
                            <label for="clave_nueva">Nueva Contrasena *</label>
                            <input type="password" id="clave_nueva" name="clave_nueva" minlength="6" required>
                            <small>Minimo 6 caracteres</small>
                        </div>

                        <div class="form-group">
                            <label for="confirmar_clave">Confirmar Nueva Contrasena *</label>
                            <input type="password" id="confirmar_clave" name="confirmar_clave" minlength="6" required>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Cambiar Contrasena</button>
                        </div>
                    </div>
                </form>

                <div class="security-tips">
                    <h3>Consejos de Seguridad</h3>
                    <ul>
                        <li>Usa una contrasena unica que no uses en otros sitios</li>
                        <li>Incluye mayusculas, minusculas, numeros y simbolos</li>
                        <li>Cambia tu contrasena periodicamente</li>
                        <li>No compartas tu contrasena con nadie</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <script>
        let datosOriginales = {};

        // Guardar datos originales al cargar la pagina
        window.onload = function() {
            guardarDatosOriginales();
        };

        function guardarDatosOriginales() {
            const form = document.getElementById('perfilForm');
            if (!form) return;

            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                datosOriginales[input.name] = input.value;
            });
        }

        function habilitarEdicion() {
            const form = document.getElementById('perfilForm');
            const inputs = form.querySelectorAll('input, select');

            inputs.forEach(input => {
                input.disabled = false;
            });

            document.getElementById('btnEditar').style.display = 'none';
            document.getElementById('btnGuardar').style.display = 'inline-block';
            document.getElementById('btnCancelar').style.display = 'inline-block';

            form.classList.add('editing');
        }

        function cancelarEdicion() {
            const form = document.getElementById('perfilForm');
            const inputs = form.querySelectorAll('input, select');

            // Restaurar valores originales
            inputs.forEach(input => {
                if (datosOriginales[input.name] !== undefined) {
                    input.value = datosOriginales[input.name];
                }
                input.disabled = true;
            });

            document.getElementById('btnEditar').style.display = 'inline-block';
            document.getElementById('btnGuardar').style.display = 'none';
            document.getElementById('btnCancelar').style.display = 'none';

            form.classList.remove('editing');
        }

        // Confirmacion antes de guardar
        const perfilForm = document.getElementById('perfilForm');
        if (perfilForm) {
            perfilForm.addEventListener('submit', function(e) {
                if (!confirm('Estas seguro de que deseas guardar los cambios?')) {
                    e.preventDefault();
                }
            });
        }

        // Cerrar alertas automaticamente despues de 5 segundos
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);
    </script>
</body>
</html>
